<script setup>
definePageMeta({
    middleware: ["auth"],
})

const { supabase } = useSupabase()
const { user, signOut } = useAuth()
const screen = ref('mobile');
const assinatura = ref();
const assinatura_data_expiracao = ref();
const limitarForm = ref(true)
const showPreencha = ref()
const usuario = ref();
const usuarioResponse = ref();
const color = ref();

const alert = ref()
const alertMessage = ref()
const loadingWidth = ref(100)

const showAlert = (message) => {
    alert.value = true
    alertMessage.value = message

    const interval = setInterval(function () {

        if (loadingWidth.value <= 0 || !alert.value) {
            // Clear the interval when the timer reaches 0
            clearInterval(interval);
            alert.value = false
            loadingWidth.value = 100;
        }
        // Decrease the width
        loadingWidth.value -= 2;

        // Update the width of the timer bar
        document.getElementById("timerBar").style.width =  loadingWidth.value + "%";
        document.getElementById("timerBarMobile").style.width =  loadingWidth.value + "%";

        // Check if the width has reached 0
       
    }, 80);


}

const setupInput = reactive({
    nome: "",
    telefone: "",
    estado: "",
})


if (process.client) {
    const screenWidth = window.innerWidth;
    if (screenWidth > 600) {
        screen.value = 'desktop'
    } else {
        screen.value = 'mobile'
    }


    usuarioResponse.value = await supabase.from("usuario").select().eq('user_id', user.value.id)
    setupInput.nome = usuarioResponse.value.data[0].nome
    setupInput.telefone = usuarioResponse.value.data[0].telefone
    setupInput.estado = usuarioResponse.value.data[0].estado


    assinatura.value = await supabase
        .from("usuario")
        .select()
        .match({ user_id: user.value.id });
    assinatura_data_expiracao.value = assinatura.value.data[0].data_expiracao
    assinatura.value = assinatura.value.data[0].status

    if (assinatura.value === 'ativo') {
        color.value = 'verde_claro'
    } else {
        color.value = 'vermelho'
    }
}












const logOut = async () => {
    const { error } = await supabase.auth.signOut()
    return navigateTo('/login')
}

const response = ref();
const customerId = ref();
const subscriptionId = ref();
const status = ref();
const expira_em = ref();
const formattedDate = ref();



const handleSubmitSetup = async () => {
    if (setupInput.nome && setupInput.telefone && setupInput.estado) {

        if (!limitarForm.value) return
        limitarForm.value = false

        if (process.client) {
            await supabase.from("usuario").update({
                nome: setupInput.nome,
                telefone: setupInput.telefone,
                estado: setupInput.estado,
            }).eq('user_id', user.value.id);;
        }
        showAlert("Informa√ß√µes editadas com sucesso!")

        showPreencha.value = false
    } else {
        showPreencha.value = true
    }
}

</script>
<template>
    <div v-if="screen === 'desktop'">
        <Transition name="alert">
            <Alert v-if="alert" @close="alert = false">
                <h1 class="text-center font-semibold">{{ alertMessage }}</h1>
            </Alert>
        </Transition>
        <!-- T√≠tulo -->
        <div class="flex flex-row items-center fixed ml-[-4%] ">
            <h1 class=" sm:pt-0 2xl:pt-2 sm:text-2xl 2xl:text-4xl text-escuro font-aristotelica  ">Minha conta | </h1>
            <h1 class="sm:text-xl 2xl:text-3xl"> üë§ </h1>
            <!-- 1F468 U+200D U+1F33E	 -->
        </div>
        <!-- ------------------------------------------------------------------------------ -->
        <div class="ml-4 h-screen flex flex-col justify-center">
            <div class="bg-verde_apagado  border-l-8 border-l-verde flex justify-evenly p-4 max-w-[30vw] mb-5">
                <div>
                    <p class="text-escuro ">Plano: <span class="font-bold capitalize">simples</span></p>
                    <p class='text-escuro '>Assinatura: <span :class="`text-${color} font-semibold capitalize`">{{
                        assinatura
                    }}</span></p>
                    <p class="text-escuro ">Expira em: <span class="font-bold">{{ assinatura_data_expiracao }}</span></p>
                </div>
                <img class="h-[70px]" src="../assets/icons/saffron.svg" alt="">
            </div>
            <h1 v-if="assinatura != 'ativo'" class=" text-vermelho font-bold animate-pulse">Sua Assinatura Expirou!</h1>

            <a v-if="assinatura != 'ativo'"
                href='https://api.whatsapp.com/send?phone=5549988765487&text=Ol%C3%A1,%20desejo%20renovar%20minha%20assinatura'
                target="_blank"
                class="bg-vermelho text-white font-semibold text-center cursor-pointer  border-l-8flex justify-evenly p-4 max-w-[30vw] mb-5">
                Clique aqui para entrar em contato e renovar sua assinatura
            </a>
            <div class="bg-verde_apagado  border-l-8 border-l-verde flex-row p-4 max-w-[30vw]">
                <h1 class="text-escuro font-semibold text-xl mb-6">Informa√ß√µes da conta</h1>
                <Transition name="pop">
                    <h1 v-if="showPreencha" class="text-center text-vermelho font-bold animate-pulse">Preencha
                        todos
                        os
                        campos</h1>
                </Transition>
                <div class="flex flex-row">
                    <div class="relative z-0 w-full mb-6 group">

                        <input type="text" disabled name="floating_email" id="floating_email"
                            class="block py-2.5 px-0 w-full text-sm text-verde bg-transparent border-0 border-b-2 border-verde appearance-none focus:outline-none focus:ring-0 focus:border-verde_claro peer"
                            placeholder=" " required :value="user.email">

                    </div>
                    <div class="relative z-0 w-full mb-6 group">

                        <input type="text" name="floating_email" id="floating_email" v-model="setupInput.telefone"
                            class="block py-2.5 px-0 w-full text-sm text-verde bg-transparent border-0 border-b-2 border-verde appearance-none focus:outline-none focus:ring-0 focus:border-verde_claro peer"
                            placeholder=" " required>
                        <label for="floating_email"
                            class="peer-focus:font-medium absolute text-sm text-verde  duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-verde_claro peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6 font-bold">
                            Telefone</label>
                    </div>



                </div>
                <div class="flex flex-col">

                    <div class="relative z-0 w-full mb-6 group">

                        <input type="text" name="floating_email" id="floating_email" v-model="setupInput.nome"
                            class="block py-2.5 px-0 w-full text-sm text-verde bg-transparent border-0 border-b-2 border-verde appearance-none focus:outline-none focus:ring-0 focus:border-verde_claro peer"
                            placeholder=" " required>
                        <label for="floating_email"
                            class="peer-focus:font-medium absolute text-sm text-verde  duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-verde_claro peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6 font-bold">Nome
                            do Administrador
                        </label>
                    </div>


                    <div class="relative z-0 w-full mb-6 group">

                        <label for="nome"
                            class=" peer-focus:font-medium absolute text-sm text-verde  duration-300 transform -translate-y-6  top-1 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-verde_claro peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale- peer-focus:-translate-y-6">Estado
                        </label>
                        <select type="text" placeholder="Jo√£o da silva" v-model="setupInput.estado"
                            class="block py-2.5 px-0 w-full text-sm text-escuro bg-transparent bg-opacity-10 bg-verde border-0 border-b-2 border-verde appearance-none focus:outline-none focus:ring-0 focus:border-verde_claro peer">
                            <option class="bg-verde font-semibold" value="AC">Acre</option>
                            <option class="bg-verde font-semibold" value="AL">Alagoas</option>
                            <option class="bg-verde font-semibold" value="AP">Amap√°</option>
                            <option class="bg-verde font-semibold" value="AM">Amazonas</option>
                            <option class="bg-verde font-semibold" value="BA">Bahia</option>
                            <option class="bg-verde font-semibold" value="CE">Cear√°</option>
                            <option class="bg-verde font-semibold" value="DF">Distrito Federal</option>
                            <option class="bg-verde font-semibold" value="ES">Esp√≠rito Santo</option>
                            <option class="bg-verde font-semibold" value="GO">Goi√°s</option>
                            <option class="bg-verde font-semibold" value="MA">Maranh√£o</option>
                            <option class="bg-verde font-semibold" value="MT">Mato Grosso</option>
                            <option class="bg-verde font-semibold" value="MS">Mato Grosso do Sul</option>
                            <option class="bg-verde font-semibold" value="MG">Minas Gerais</option>
                            <option class="bg-verde font-semibold" value="PA">Par√°</option>
                            <option class="bg-verde font-semibold" value="PB">Para√≠ba</option>
                            <option class="bg-verde font-semibold" value="PR">Paran√°</option>
                            <option class="bg-verde font-semibold" value="PE">Pernambuco</option>
                            <option class="bg-verde font-semibold" value="PI">Piau√≠</option>
                            <option class="bg-verde font-semibold" value="RJ">Rio de Janeiro</option>
                            <option class="bg-verde font-semibold" value="RN">Rio Grande do Norte</option>
                            <option class="bg-verde font-semibold" value="RS">Rio Grande do Sul</option>
                            <option class="bg-verde font-semibold" value="RO">Rond√¥nia</option>
                            <option class="bg-verde font-semibold" value="RR">Roraima</option>
                            <option class="bg-verde font-semibold" value="SC">Santa Catarina</option>
                            <option class="bg-verde font-semibold" value="SP">S√£o Paulo</option>
                            <option class="bg-verde font-semibold" value="SE">Sergipe</option>
                            <option class="bg-verde font-semibold" value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>
                <div class="flex w-full justify-evenly ">
                    <button @click="handleSubmitSetup" data-modal-toggle="defaultModal" type="button"
                    class="text-claro bg-escuro flex  justify-between items-center space-x-2  rounded-lg   text-sm font-medium px-3 mt-4 py-2.5">
                        Editar Informa√ß√µes</button>
                    <button @click="logOut()" data-modal-toggle="defaultModal" type="button"
                        class="text-claro bg-escuro flex  justify-between items-center space-x-2  rounded-lg   text-sm font-medium px-3 mt-4 py-2.5">

                        <h1>Fazer logout</h1>
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" fill="#DDE0D0"
                            width="24">
                            <path
                                d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z" />
                        </svg>


                    </button>
                </div>
            </div>

        </div>

    </div>
    <div v-if="screen === 'mobile'">
        <Transition name="alert_mobile">
            <Alert v-if="alert" @close="alert = false">
                <h1 class="text-center font-semibold">{{ alertMessage }}</h1>
            </Alert>
        </Transition>
        <div class=" flex flex-col justify-center">
            <div class="bg-verde_apagado text-escuro border-l-8 border-l-verde flex justify-evenly items-center p-4  mb-5 ">
                <div>
                    <p class='text-escuro '>Assinatura: <span :class="`text-${color} font-semibold capitalize`">{{
                        assinatura
                    }}</span></p>
                    <p class='text-escuro '><span :class="`text-${color} font-semibold`">{{ status }}</span></p>
                    <p class="text-escuro ">Expira em: <span class="font-bold text-xs">{{ assinatura_data_expiracao
                    }}</span></p>
                </div>
                <img class="h-[40px]" src="../assets/icons/saffron.svg" alt="">
            </div>
            <h1 v-if="assinatura != 'ativo'" class="text-center text-vermelho font-bold animate-pulse">Sua Assinatura
                Expirou!</h1>
            <a v-if="assinatura != 'ativo'"
                href='https://api.whatsapp.com/send?phone=5549988765487&text=Ol%C3%A1,%20desejo%20renovar%20minha%20assinatura'
                target="_blank"
                class="bg-vermelho text-white font-semibold text-center cursor-pointer  border-l-8flex justify-evenly p-4 w-full mb-5">
                Clique aqui para entrar em contato e renovar sua assinatura
            </a>
            <div class="bg-verde_apagado text-escuro border-l-8 border-l-verde flex-row p-4 z-[-1]">
                <h1 class="text-escuro font-semibold text-xl mb-6">Informa√ß√µes da conta</h1>
                <Transition name="pop">
                    <h1 v-if="showPreencha" class="text-center text-vermelho font-bold animate-pulse">Preencha
                        todos
                        os
                        campos</h1>
                </Transition>
                <div class="flex flex-col">
                    <div class="relative z-0 w-full mb-6 group">

                        <input type="text" disabled name="floating_email" id="floating_email"
                            class="block py-2.5 px-0 w-full text-sm text-verde bg-transparent border-0 border-b-2 border-verde appearance-none focus:outline-none focus:ring-0 focus:border-verde_claro peer"
                            placeholder=" " required :value="user.email">

                    </div>
                    <div class="relative z-0 w-full mb-6 group">

                        <input type="text" name="floating_email" id="floating_email" v-model="setupInput.telefone"
                            class="block py-2.5 px-0 w-full text-sm text-verde bg-transparent border-0 border-b-2 border-verde appearance-none focus:outline-none focus:ring-0 focus:border-verde_claro peer"
                            placeholder=" " required>
                        <label for="floating_email"
                            class="peer-focus:font-medium absolute text-sm text-verde  duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-verde_claro peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6 font-bold">
                            Telefone</label>
                    </div>



                </div>
                <div class="flex flex-col">

                    <div class="relative z-[0] w-full mb-6 group">

                        <input type="text" name="floating_email" id="floating_email" v-model="setupInput.nome"
                            class="block py-2.5 px-0 w-full text-sm text-verde bg-transparent border-0 border-b-2 border-verde appearance-none focus:outline-none focus:ring-0 focus:border-verde_claro peer"
                            placeholder=" " required>
                        <label for="floating_email"
                            class="peer-focus:font-medium absolute text-sm text-verde  duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-verde_claro peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6 font-bold">Nome
                            do Administrador
                        </label>
                    </div>


                    <div class="relative z-0 w-full mb-6 group">

                        <label for="nome"
                            class=" peer-focus:font-medium absolute text-sm text-verde  duration-300 transform -translate-y-6  top-1 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-verde_claro peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale- peer-focus:-translate-y-6">Estado
                        </label>
                        <select type="text" placeholder="Jo√£o da silva" v-model="setupInput.estado"
                            class="block py-2.5 px-0 w-full text-sm text-escuro bg-transparent bg-opacity-10 bg-verde border-0 border-b-2 border-verde appearance-none focus:outline-none focus:ring-0 focus:border-verde_claro peer">
                            <option class="bg-verde font-semibold" value="AC">Acre</option>
                            <option class="bg-verde font-semibold" value="AL">Alagoas</option>
                            <option class="bg-verde font-semibold" value="AP">Amap√°</option>
                            <option class="bg-verde font-semibold" value="AM">Amazonas</option>
                            <option class="bg-verde font-semibold" value="BA">Bahia</option>
                            <option class="bg-verde font-semibold" value="CE">Cear√°</option>
                            <option class="bg-verde font-semibold" value="DF">Distrito Federal</option>
                            <option class="bg-verde font-semibold" value="ES">Esp√≠rito Santo</option>
                            <option class="bg-verde font-semibold" value="GO">Goi√°s</option>
                            <option class="bg-verde font-semibold" value="MA">Maranh√£o</option>
                            <option class="bg-verde font-semibold" value="MT">Mato Grosso</option>
                            <option class="bg-verde font-semibold" value="MS">Mato Grosso do Sul</option>
                            <option class="bg-verde font-semibold" value="MG">Minas Gerais</option>
                            <option class="bg-verde font-semibold" value="PA">Par√°</option>
                            <option class="bg-verde font-semibold" value="PB">Para√≠ba</option>
                            <option class="bg-verde font-semibold" value="PR">Paran√°</option>
                            <option class="bg-verde font-semibold" value="PE">Pernambuco</option>
                            <option class="bg-verde font-semibold" value="PI">Piau√≠</option>
                            <option class="bg-verde font-semibold" value="RJ">Rio de Janeiro</option>
                            <option class="bg-verde font-semibold" value="RN">Rio Grande do Norte</option>
                            <option class="bg-verde font-semibold" value="RS">Rio Grande do Sul</option>
                            <option class="bg-verde font-semibold" value="RO">Rond√¥nia</option>
                            <option class="bg-verde font-semibold" value="RR">Roraima</option>
                            <option class="bg-verde font-semibold" value="SC">Santa Catarina</option>
                            <option class="bg-verde font-semibold" value="SP">S√£o Paulo</option>
                            <option class="bg-verde font-semibold" value="SE">Sergipe</option>
                            <option class="bg-verde font-semibold" value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>

                <button @click="handleSubmitSetup" data-modal-toggle="defaultModal" type="button"
                    class="text-claro bg-verde  rounded-lg   text-sm font-medium px-5 py-2.5">
                    Editar Informa√ß√µes</button>
            </div>
        </div>
        <button @click="logOut()" data-modal-toggle="defaultModal" type="button"
            class="text-claro bg-escuro flex  justify-between items-center space-x-2  rounded-lg   text-sm font-medium px-3 mt-4 py-2.5">

            <h1>Fazer logout</h1>
            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" fill="#DDE0D0" width="24">
                <path
                    d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z" />
            </svg>


        </button>
        <section class="h-[60px]"></section>
    </div>
</template>